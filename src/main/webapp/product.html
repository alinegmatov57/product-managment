<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Products</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Product List</h2>
    <button class="btn btn-primary" onclick="openAddModal()">+ Add Product</button>
  </div>

  <table class="table table-bordered table-striped shadow-sm bg-white">
    <thead class="table-dark">
    <tr>
      <th>Name</th>
      <th>Status</th>
      <th>Type</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody id="productList"></tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">Add Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="productForm">
        <div class="modal-body">
          <input type="hidden" id="productId">
          <div class="mb-3">
            <label for="productName" class="form-label">Name</label>
            <input type="text" id="productName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="productStatus" class="form-label">Status</label>
            <select id="productStatus" class="form-select" required>
              <option value="ACTIVE">ACTIVE</option>
              <option value="INACTIVE">INACTIVE</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="productType" class="form-label">Type ID</label>
            <input type="number" id="productType" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const token = localStorage.getItem("token");
  if (!token) location.href = "index.html";

  let productModal;
  document.addEventListener("DOMContentLoaded", () => {
    productModal = new bootstrap.Modal(document.getElementById('productModal'));
    loadProducts();

    document.getElementById("productForm").addEventListener("submit", function (event) {
      event.preventDefault();

      const id = document.getElementById("productId").value;
      const product = {
        name: document.getElementById("productName").value,
        status: document.getElementById("productStatus").value,
        type: {
          id: parseInt(document.getElementById("productType").value)
        }
      };

      const method = id ? "PUT" : "POST";
      const url = id ? `/api/products/${id}` : "/api/products";

      fetch(url, {
        method: method,
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(product)
      })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  productModal.hide();
                  loadProducts();
                } else {
                  alert("Error: " + data.message);
                }
              });
    });
  });

  function loadProducts() {
    fetch("/api/products", {
      headers: {
        "Authorization": "Bearer " + token
      }
    })
            .then(res => res.json())
            .then(response => {
              if (response.success) {
                const products = response.data;
                const productList = document.getElementById("productList");
                productList.innerHTML = "";

                products.forEach(product => {
                  const row = document.createElement("tr");
                  row.innerHTML = `
              <td>${product.name}</td>
              <td>${product.status}</td>
              <td>${product.type.typeName}</td>
              <td>
                <button class="btn btn-sm btn-warning" onclick="openUpdateModal(${product.id}, '${product.name}', '${product.status}', ${product.type.id})">Update</button>
                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">Delete</button>
              </td>
            `;
                  productList.appendChild(row);
                });
              } else {
                alert("Failed to load products");
              }
            });
  }

  function openAddModal() {
    document.getElementById("productForm").reset();
    document.getElementById("productId").value = "";
    document.getElementById("productModalLabel").innerText = "Add Product";
    productModal.show();
  }

  function openUpdateModal(id, name, status, typeId) {
    document.getElementById("productId").value = id;
    document.getElementById("productName").value = name;
    document.getElementById("productStatus").value = status;
    document.getElementById("productType").value = typeId;
    document.getElementById("productModalLabel").innerText = "Update Product";
    productModal.show();
  }

  function deleteProduct(id) {
    if (confirm("Are you sure you want to delete this product?")) {
      fetch(`/api/products/${id}`, {
        method: "DELETE",
        headers: {
          "Authorization": "Bearer " + token
        }
      })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  loadProducts();
                } else {
                  alert("Delete failed: " + data.message);
                }
              });
    }
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
